/**
 * Analysis types for AI-powered code walkthrough
 *
 * Defines the structure for LLM-generated walkthrough scripts that help
 * instructors discuss student submissions during lectures.
 */

/**
 * Severity level for an analysis issue
 */
export type IssueSeverity = 'error' | 'misconception' | 'style' | 'good-pattern';

/**
 * A single issue identified across student submissions
 */
export interface AnalysisIssue {
  /** Short title describing the issue */
  title: string;

  /** Detailed explanation of the issue for instructor context */
  explanation: string;

  /** Number of students exhibiting this issue */
  count: number;

  /** Internal student IDs of all students with this issue */
  studentIds: string[];

  /** Anonymous label for the representative student (e.g., "Student A") */
  representativeStudentLabel: string;

  /** Internal ID of the representative student (used for featuring) */
  representativeStudentId: string;

  /** Severity/type classification */
  severity: IssueSeverity;
}

/**
 * Raw response structure expected from Gemini API (v2 issue-based format)
 */
export interface GeminiAnalysisResponseV2 {
  /** Issues identified across submissions */
  issues: Array<{
    title: string;
    explanation: string;
    studentLabels: string[];
    severity: IssueSeverity;
  }>;

  /** Labels of students who have finished/submitted */
  finishedStudentLabels: string[];

  /** Optional high-level note about the class overall */
  overallNote?: string;
}

/**
 * Summary statistics for the walkthrough
 */
export interface WalkthroughSummary {
  /** Total number of students in the session */
  totalSubmissions: number;

  /** Number of submissions filtered out (empty/unchanged) */
  filteredOut: number;

  /** Number of submissions sent to LLM for analysis */
  analyzedSubmissions: number;

  /** Estimate of how many students are finished, in progress, or not started */
  completionEstimate: {
    finished: number;
    inProgress: number;
    notStarted: number;
  };

  /** Warning message if many submissions were filtered */
  warning?: string;
}

/**
 * The complete walkthrough script generated by LLM analysis
 */
export interface WalkthroughScript {
  /** Session ID this script was generated for */
  sessionId: string;

  /** Ordered list of issues to discuss */
  issues: AnalysisIssue[];

  /** Summary statistics */
  summary: WalkthroughSummary;

  /** Optional high-level note about the class overall */
  overallNote?: string;

  /** Timestamp when this script was generated */
  generatedAt: Date;
}

/**
 * Request payload for the analyze endpoint
 */
export interface AnalyzeCodeRequest {
  /** No additional parameters needed - session ID is in URL */
}

/**
 * Response from the analyze endpoint
 */
export interface AnalyzeCodeResponse {
  success: boolean;
  script?: WalkthroughScript;
  error?: string;
}

/**
 * Input for the Gemini analysis service
 */
export interface AnalysisInput {
  /** Session ID for reference */
  sessionId: string;

  /** Problem title and description */
  problemTitle: string;
  problemDescription: string;

  /** Starter code (for filtering unchanged submissions) */
  starterCode: string;

  /** Student submissions to analyze */
  submissions: Array<{
    studentId: string;
    code: string;
  }>;
}
